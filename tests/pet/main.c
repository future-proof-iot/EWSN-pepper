
#include <string.h>

#include "embUnit.h"
#include "ebid.h"
#include "random.h"
#include "crypto_manager.h"

static crypto_manager_keys_t keys_bob = {
    .pk = {
        0x5c, 0x24, 0x4c, 0x6e, 0xf9, 0x7a, 0x02, 0x9c,
        0x83, 0xe3, 0x67, 0xac, 0x3c, 0x31, 0xd0, 0x20,
        0x97, 0xdc, 0x59, 0xf8, 0xab, 0xe4, 0xa5, 0xb8,
        0xf6, 0xd9, 0x07, 0x11, 0x3d, 0xce, 0x90, 0x25
    },
    .sk = {
        0x7a, 0xdd, 0xb8, 0x16, 0x6f, 0x48, 0x01, 0xb7,
        0x25, 0xa5, 0x0f, 0x4b, 0x69, 0x64, 0x93, 0xf2,
        0xf4, 0x12, 0x4a, 0x3e, 0x72, 0x6b, 0x10, 0xda,
        0x45, 0x83, 0x18, 0xe6, 0xff, 0x12, 0xaf, 0x50
    }
};

static crypto_manager_keys_t keys_alice = {
    .pk = {
        0x6b, 0x59, 0xb9, 0xd8, 0x44, 0x3e, 0x82, 0xf2,
        0x9e, 0xcb, 0x4b, 0x7c, 0xd2, 0x29, 0x9a, 0xf5,
        0xc0, 0x69, 0xe8, 0xb9, 0x5f, 0x3e, 0xb1, 0x94,
        0x72, 0xa0, 0xeb, 0x55, 0x52, 0x6e, 0x9c, 0x34
    },
    .sk = {
        0x72, 0xf0, 0xc1, 0xd6, 0x31, 0x20, 0xc3, 0x4f,
        0x99, 0x54, 0xf7, 0xae, 0x65, 0xc6, 0xcb, 0x89,
        0xcc, 0x4c, 0xa7, 0x4e, 0x3b, 0x75, 0xdf, 0x6d,
        0xbf, 0xe5, 0x69, 0xa1, 0x99, 0x59, 0xae, 0xf8
    }
};

static void setUp(void)
{
    random_init(1);
}

static void tearDown(void)
{
    /* Finalize */
}

static void test_crypto_manager_gen_pets(void)
{
    ebid_t bob;
    ebid_t alice;
    pet_t pet_bob;
    pet_t pet_alice;
    ebid_init(&bob);
    ebid_init(&alice);
    ebid_generate(&bob, &keys_bob);
    ebid_generate(&alice, &keys_alice);
    crypto_manager_gen_pets(&keys_alice, bob.parts.ebid.u8, &pet_alice);
    crypto_manager_gen_pets(&keys_bob, alice.parts.ebid.u8, &pet_bob);
    TEST_ASSERT(memcmp(pet_bob.etl, pet_alice.rtl, sizeof(pet_bob.etl)));
    TEST_ASSERT(memcmp(pet_alice.etl, pet_bob.rtl, sizeof(pet_bob.etl)));
}

Test *tests_ebid(void)
{
    EMB_UNIT_TESTFIXTURES(fixtures) {
        new_TestFixture(test_crypto_manager_gen_pets),
    };

    EMB_UNIT_TESTCALLER(ebid_tests, setUp, tearDown, fixtures);
    return (Test*)&ebid_tests;
}

int main(void)
{
    TESTS_START();
    TESTS_RUN(tests_ebid());
    TESTS_END();

    return 0;
}
